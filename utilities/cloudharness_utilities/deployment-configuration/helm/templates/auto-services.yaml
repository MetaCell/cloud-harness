{{/* Services */}}
{{- define "deploy_utils.service" }}
apiVersion: v1
kind: Service
metadata:
  name: {{ .app.name | quote }}
  labels:
    app: {{ .app.name | quote }}
{{ include "deploy_utils.labels" .root | indent 4 }}
spec:
  selector:
    app: {{ .app.name | quote }}
  ports:
    - port: {{ .app.port }}
      name: http
{{- end }}


{{- range $app := .Values.apps }}
  {{- if and (hasKey $app "port") ($app.autoservice | default true)  }}
---
  {{ include "deploy_utils.service" (dict "root" $ "app" $app) }}
  {{- range $subapp := $app }}
  {{- if contains "map" (typeOf $subapp)  }}
  {{- if and (hasKey $subapp "port") ($subapp.autoservice | default false) }}
---
      {{ include "deploy_utils.service" (dict "root" $ "app" $subapp) }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- end }}
  {{- end }}


