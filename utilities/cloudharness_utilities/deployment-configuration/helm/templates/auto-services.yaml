{{/* Services */}}
{{- define "deploy_utils.service" }}
apiVersion: v1
kind: Service
metadata:
  name: {{ .app.harness.service.name | quote }}
  labels:
    app: {{ .app.harness.deployment.name | quote }}
{{ include "deploy_utils.labels" .root | indent 4 }}
spec:
  selector:
    app: {{ .app.deploymentname | quote }}
  ports:
    - port: {{ .app.harness.deployment.port }}
      name: http
{{- end }}


{{- range $app := .Values.apps }}
  {{- if and (hasKey $app "port") $app.autoservice  }}
---
  {{- range $subapp := $app }}
  {{- if contains "map" (typeOf $subapp)  }}
  {{- if and (hasKey $subapp "port") $subapp.autoservice }}
---
      {{ include "deploy_utils.service" (dict "root" $ "app" $subapp) }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- end }}
  {{- end }}


